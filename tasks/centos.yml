- name: Ensure Hortonworks repositories are present
  copy: >
    src={{ item }}
    dest=/etc/yum.repos.d/{{ item }}
  with_items:
    - hdp.repo
    - ambari.repo
  tags:
    - zookeeper
    - repos

- name: Install Java and ZooKeeper
  yum: name={{ item }} state=present enablerepo=HDP-1.3.0.0
  with_items:
    - java-1.7.0-openjdk
    - zookeeper-server
  tags:
    - zookeeper
    - pkgs

#
# Hortonworks' packages are buggy in regards
# to how they create users and groups. This
# below will ensure sanity
#
- name: Ensure the zookeeper exists
  group: >
    name=zookeeper
    gid=498
    state=present
  tags:
    - zookeeper
    - pkgs

- name: Ensure the zookeeper users default group is the zookeeper group
  user: >
    name=zookeeper
    uid=498
    createhome=no
    group=zookeeper
    state=present
  tags:
    - zookeeper
    - pkgs

#
# End fix
#
- name: Make sure required iptables ports are open
  lineinfile: >
    dest=/etc/sysconfig/iptables
    state=present
    regexp='--dport {{ item }} -j ACCEPT'
    insertbefore='-m tcp --dport 22 -j ACCEPT'
    line='-A INPUT -m state --state NEW -m tcp -p tcp --dport {{ item }} -j ACCEPT'
  with_items:
   - $zookeeper_client_port
   - $zookeeper_leader_port
   - $zookeeper_election_port
  tags:
    - zookeeper
    - firewall

- name: Reload iptables
  command: /etc/init.d/iptables restart
  tags:
    - zookeeper
    - firewall
